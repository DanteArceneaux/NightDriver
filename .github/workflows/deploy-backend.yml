name: Verify Backend Deployment (Render)

on:
  push:
    branches:
      - main # Or your backend branch, if different

jobs:
  verify-deployment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Wait for Render Deployment
        run: |
          echo "Waiting for Render service to deploy..."
          # Render auto-deploys on push to main, so we wait a bit for it to start
          sleep 30

      - name: Get Backend Service URL
        id: get_url
        run: |
          BACKEND_URL="https://nightdriver.onrender.com"
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_OUTPUT

      - name: Verify Backend Health Check
        run: |
          echo "Checking backend health at ${{ steps.get_url.outputs.BACKEND_URL }}/api/health"
          # Retry logic for Render cold starts
          for i in $(seq 1 10); do
            if curl -f -s ${{ steps.get_url.outputs.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "✅ Backend is healthy!"
              exit 0
            fi
            echo "Attempt $i failed, waiting 15s..."
            sleep 15
          done
          echo "❌ Backend health check failed after 10 attempts"
          exit 1

      - name: Report Success
        run: echo "Render Backend deployment verified successfully!"

