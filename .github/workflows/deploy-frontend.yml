name: Verify Frontend Deployment (Vercel)

on:
  push:
    branches:
      - main # Or your frontend branch, if different

jobs:
  verify-deployment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_API_TOKEN }}
        working-directory: ./frontend

      - name: Build Project Locally (optional, but good for early failure detection)
        run: vercel build --token=${{ secrets.VERCEL_API_TOKEN }}
        working-directory: ./frontend

      - name: Get Vercel Deployment URL
        id: get_url
        run: |
          # This assumes a successful deployment on Vercel's side is already triggered by the push
          # We'll use grep -o to extract the first string starting with https://
          DEPLOYMENT_URL=$(vercel ls night-driver --token=${{ secrets.VERCEL_API_TOKEN }} | grep -o 'https://[a-zA-Z0-9\.-]*' | head -n 1)
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT

      - name: Wait for Vercel Deployment to be Ready
        run: |
          echo "Waiting for deployment at ${{ steps.get_url.outputs.DEPLOYMENT_URL }}"
          for i in $(seq 1 30);
          do
            if curl -s -f -o /dev/null ${{ steps.get_url.outputs.DEPLOYMENT_URL }};
            then
              echo "Deployment is ready!";
              exit 0;
            fi;
            echo "Attempt $i: Deployment not ready yet, waiting 10 seconds...";
            sleep 10;
          done;
          echo "Deployment timed out after 5 minutes.";
          exit 1;

      - name: Verify Frontend Accessibility
        run: |
          # Basic curl to ensure the page responds
          curl -f -s -o /dev/null ${{ steps.get_url.outputs.DEPLOYMENT_URL }}
        
      - name: Report Success
        run: echo "Vercel Frontend deployment verified successfully!"

