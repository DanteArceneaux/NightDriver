name: Verify Frontend Deployment (Vercel)

on:
  push:
    branches:
      - main # Or your frontend branch, if different

jobs:
  verify-deployment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Production URL
        id: get_url
        run: |
          # Use the main production URL (Vercel auto-deploys on push)
          DEPLOYMENT_URL="https://night-driver.vercel.app"
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Will verify: $DEPLOYMENT_URL"

      - name: Wait for Vercel Deployment to be Ready
        run: |
          URL="${{ steps.get_url.outputs.DEPLOYMENT_URL }}"
          echo "Waiting for Vercel deployment at $URL"
          echo "Note: Vercel needs time to build and deploy (usually 1-3 minutes)"
          
          # Wait 60 seconds before first check to give Vercel time to start building
          echo "Initial wait: 60 seconds..."
          sleep 60
          
          # Then check up to 20 times with 15 second intervals (total: ~6 minutes)
          for i in $(seq 1 20);
          do
            # Get the HTTP status code
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            echo "Attempt $i: Received HTTP $STATUS"
            
            # 200, 301, 302 are successful responses
            # 401/403 are accepted because Vercel Deployment Protection may block curl
            if [ "$STATUS" -eq "200" ] || [ "$STATUS" -eq "301" ] || [ "$STATUS" -eq "302" ] || [ "$STATUS" -eq "401" ] || [ "$STATUS" -eq "403" ]; then
              echo "✅ Deployment is ready and responding (Status $STATUS)!";
              exit 0;
            fi;
            
            echo "Waiting 15 seconds...";
            sleep 15;
          done;
          echo "❌ Deployment timed out after ~6 minutes.";
          exit 1;

      - name: Verify Frontend Accessibility
        run: |
          # Final verification that the site is accessible
          URL="${{ steps.get_url.outputs.DEPLOYMENT_URL }}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
          
          echo "Final check for $URL - Status: $STATUS"
          
          if [ "$STATUS" -eq "200" ] || [ "$STATUS" -eq "301" ] || [ "$STATUS" -eq "302" ] || [ "$STATUS" -eq "401" ] || [ "$STATUS" -eq "403" ]; then
            echo "✅ Frontend is accessible (Status $STATUS)";
            echo "✅ Deployment verification complete!";
          else
            echo "❌ Accessibility check failed (Status $STATUS)";
            exit 1;
          fi
        
      - name: Report Success
        run: echo "Vercel Frontend deployment verified successfully!"

